# Настройка и запуск Сайнера

## Конфигурирование поставки

Перед началом разворачивания приложения необходимо отредактировать файл ***esia_signer/.env*** заменив значения переменных на свои.

`SIGNER_IMAGE` и `SIGNER_IMAGE_TAG` - значения Docker образа для Signer (по-умолчанию *harbor.rnds.pro/rnds/signer-cpp:smolensk-csp*)

`SIGNER_WEB_PORT` - внешний порт контейнера Singer (по-умолчанию *8505*)

`CRYPTOPRO_CSP_LICENSE`- Лицензионный номер для криптопро CSP на одно рабочее место

-----

## Подготовка сервиса подписания запросов Signer
  
Перед запуском сервиса необходимо отредактировать конфигурационный файл ***esia_signer/config.yml***

```yml
username: "admin" #Имя пользователя для http basic authentication
password: "123456" #Пароль пользователя для http basic authentication
port: 8505 #Порт на котором приложение внутри контейнера будет ожидать входящие подключения (при смене порта, следует учитывать настройки в файле docker-compose.yml)
provider: csp #Используемый криптопровайдер для обращения к сертификату (может принимать значения: csp, openssl)
csp: #Блок настроек для криптопровайдера csp
  keystore: HDImage #Хранилище сертификатов (не менять)
  keys: 
    - alias: "esia" #Алиас сертификата (необходим для выполнения запросов к конкретному сертификату. Может быть произвольным)
      name: "xxxxxx" #Имя криптоконтейнера
      pin: "" #Pin код для криптоконтейнера (если он есть, иначе оставить пустым)
openssl: #Блок настроек для криптопровайдера openssl
  keysDir: /home/app/openssl_keys #Директория внутри контейнера в которой должны лежать сертификат и ключ в формате pem.
log:
  level: debug
  dir: ./logs
  maxSize: 1048576
  #colors: auto Управление цветным выводом в консоль. Поддерживаемые значения: on, off, auto. По умолчанию: auto
  #maxCount Максимальное количество файлов логов. По умолчанию: 10
  #baseName: signer Базовое имя файла лога. По умолчанию: signer
```

В зависимости от выбранного провайдера дальнейший процесс настройки будет различаться.

-----

## КриптоПро CSP

Копирование КЭП (далее по тексту - контейнер) в сервис подписания запросов (Signer)

КЭП - (Квалифицированная электронная подпись) Состоит из 6-ти *.key файлов, находящихся в директории вида name.000 :

- header.key
- name.key
- primary.key
- masks.key
- primary2.key
- masks2.key

Данную директорию (name.000) с файлами необходимо скопировать в директорию cryptopro_keys

Итоговый результат копирования должен выглядеть следующим образом:

```bash
cryptopro_keys/name.000/*
```

-----

## Openssl

Для загрузки openssl сертификата и ключа, необходимо их сохранить следующим образом:

```bash
openssl_keys/
└── esia # Будущий Алиас сертификата
    ├── cert.pem
    └── key.pem
```

-----

## Запуск сервиса подписания запросов Signer

Запуск Signer производится с помощью скрипта `run.sh` вместе с ЕСИА Шлюзом и необходимым ПО. Процесс запуска описан в [Инструкции по подготовке и запуску коробочного решения](../README.md)

-----

## Проверка сервиса Signer

### Проверка криптоконтейнера (КриптоПро)

Чтобы проверить, загружен ли криптоконтейнер в signer нужно получить ID Docker-контейнера Signer и зайти в него через `docker exec`:

```bash
docker ps -a | grep signer
docker exec -it <id_контейнера> bash
```

Внутри Docker-контейнера можно проверить, находится ли криптоконтейнер в нем:

```bash
ls -lah /var/opt/cprocsp/keys/root
```

И с помощью утилиты `csptest` проверить его загрузку в Signer:

```bash
csptest -keyset -enum_cont -verifycontext -fqcn
```

### Проверка файлов OpenSSL

Чтобы проверить, загружены ли файлы в signer нужно получить ID Docker-контейнера Signer и зайти в него через `docker exec`:

```bash
docker ps -a | grep signer
docker exec -it <id_контейнера> bash
```

Внутри контейнера можно проверить, находится ли сертификат с ключом в нем:

```bash
ls -lah /home/app/openssl_keys
```

------

## Проверка корректной работы сервиса подписания запросов Signer

Также для проверки корректной работы сервиса подписания запросов (Signer) необходимо выполнить запрос к сервису с помощью команды:

```bash
curl -X POST -d 'content=test' -d 'cert=esia' -u admin:123456 http://127.0.0.1:8505/raw
```

где:

- `esia` - алиас контейнера, заданный на предыдущем этапе настройки
- `admin` - имя пользователя для http basic authentication, заданный на предыдущем этапе настройки
- `123456` - пароль пользователя для http basic authentication, заданный на предыдущем этапе настройки

Корректным результатом выполнения команды будет следующий результат:

```json
{"signature":"FuJIp...jaQCFKjR0J+e+/TzpS8Hsg==","certificate":"MIIKyDC
.......
WddM7aQ89R9akeQ38uYd7usbbw==","certificate_algorithm":"1.2.643.7.1.1.3.2"}
```






