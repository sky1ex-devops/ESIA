# Инструкция по подготовке и запуску коробочного решения

[Описание коробочного решения ЕСИА Шлюз](./ABOUT_BOX.md)

Данный репозиторий содержит в себе каталоги с исходным кодом скрипта для запуска сервисов поставки, а также с вспомогательными скриптами и исходниками коробки

## Каталог со скриптами

Каталог со скриптами для работы коробочного решения - ***./scripts***

`login.sh` - авторизация в Docker Registry

`box_run.sh` - генерирование приватного OpenSSL ключа; рендеринг переменных окружения для каждого отдельного компонента поставки; запуск контейнеров ЕСИА Шлюза, Signer, а также дополнительного ПО

`box_show_config.sh` - отображение конфигурации контейнеров

`box_down.sh` - остановка и удаление контейнеров

Каждый скрипт из каталога ***./scripts*** является хелпером и взаимодействует с локальными наборами bash-скриптов для каждого ПО (находящихся в одной директории с данным ПО).  
Далее по инструкции будет более подробная инструкция по каждому скрипту  

-----

## Авторизация в Harbor

Для начала необходимо завести учетную запись в ***harbor.rnds.pro*** для клиента в группах *rnds* и *sentinel* при помощи сотрудников компании RNDSOFT. Далее, с полученными авторизационными данными запускаем скрипт `login.sh` c логином и паролем в качестве двух переменных:

```bash
./login.sh <login> <password>
```
где:  
- \<login> - логин учётной записи от harbor.rnds.pro  
- \<password> - пароль учётной записи от harbor.rnds.pro

-----

## Настройка коробочного решения ЕСИА Шлюз

Перед запуском коробочного решения необходимо произвести настройку основного и дополнительного ПО. Для этого открываем файл [.env.main](.env.main):

> Необходимые для настройки переменные окружения вынесены в файл `.env.main` и подлежат изменению в именно нём. После внесения и сохранения всех изменеий, скрипт запуска контейнеров (*о работе скрипта далее*) произведёт рендеринг переменных окружения из `.env.main` и внесёт данные изменения в локальные `.env`-файлы каждого запускаемого контейнера.  

### Настройка ЕСИА Шлюза

`SENTINEL_IMAGE` и `SENTINEL_IMAGE_TAG` - значения Docker образа для ЕСИА Шлюза (по-умолчанию *harbor.rnds.pro/sentinel/sentinel-ror:box2.32*)

`ESIA_GATE_URI` - URI адрес тенанта ЕСИА Шлюза (по-умолчанию *https://esia.example.com*) 

Настройки БД для тенанта ЕСИА Шлюза (по-умолчанию стоят следующие значения):
`DATABASE_HOST`="db"  
`DATABASE_NAME`="main_esia_db"
`DATABASE_USER`="postgres"  
`DATABASE_PASS`="0QPnk5dVcAEg"  
`DATABASE_PORT`="5432" 

`SIGNER_IP`, `DATABASE_IP` и `REDIS_IP` - IP адреса инстансов для сервисов, с которыми взаимодействует (Сайнер, БД, Redis).

`MAIN_ADMIN_PASSWORD` - Пароль к главной учетной записи ЕСИА Шлюза. **Логин** - ***admin@esia.pro***

`SMTP_USER_NAME`, `SMTP_PORT`, `SMTP_PASSWORD` и `SMTP_ADDRESS` - настройки доступа к вашему почтовому серверу.

> В *esia_gate/.env* и *esia_gate/tenant.yml* также есть настройки, которые не подлежат изменению без определённой необходимости.

[Отдельное описание настройки ЕСИА Шлюза](./esia_gate/README.md)

-----



### Настройка ПО Signer

`SIGNER_IMAGE` и `SIGNER_IMAGE_TAG` - значения Docker образа для Signer (по-умолчанию *harbor.rnds.pro/rnds/signer-cpp:smolensk-csp*)

`SIGNER_USERNAME` - имя пользователя для http basic authentication (по-умолчанию *admin*)

`SIGNER_PASSWORD` - пароль пользователя для http basic authentication (по-умолчанию *123456*)

`SIGNER_WEB_PORT` - внешний порт контейнера с Signer (по-умолчанию *8505*)

`SIGNER_PROVIDER` - используемый криптопровайдер для обращения к сертификату. Может принимать значения: csp, openssl (по-умолчанию *csp*)

***Если криптопровайдером выбран CSP:***

`CRYPTOPRO_CSP_LICENSE` - лицензионный номер для криптопро CSP на одно рабочее место (по-умолчанию не задан)

`CRYPTOPRO_CSP_ALIAS` - алиас сертификата. Необходим для выполнения запросов к конкретному сертификату. Может быть произвольным (по-умолчанию *esia*)

`CRYPTOPRO_CSP_NAME` - имя криптоконтейнера (находится в name.key криптоконтейнера) (по-умолчанию *name*)

`CRYPTOPRO_CSP_PIN` - pin код для криптоконтейнера (если он есть, иначе оставить пустым) (по-умолчанию не задан)

> В *esia_signer/.env* и *esia_signer/config.yml* также есть настройки, которые не подлежат изменению без определённой необходимости.

В зависимости от выбранного провайдера (`SIGNER_PROVIDER`) дальнейший процесс настройки будет различаться.

#### 1. КриптоПро CSP

Копирование КЭП (далее по тексту - контейнер) в сервис подписания запросов (Signer)

КЭП - (Квалифицированная электронная подпись) Состоит из 6-ти *.key файлов, находящихся в директории вида name.000 :

- header.key
- name.key
- primary.key
- masks.key
- primary2.key
- masks2.key

Данную директорию (name.000) с файлами необходимо скопировать в директорию *./esia_signer/cryptopro_keys*

Итоговый результат копирования должен выглядеть следующим образом:

```bash
cryptopro_keys/name.000/*
```

#### 2. Openssl:

Для загрузки openssl сертификата и ключа, необходимо их сохранить следующим образом:

```bash
openssl_keys/
└── esia # Будущий Алиас сертификата
    ├── cert.pem
    └── key.pem
```

#### Проверка сервиса Signer:

#### Проверка криптоконтейнера (КриптоПро):

Чтобы проверить, загружен ли криптоконтейнер в signer нужно получить ID Docker-контейнера Signer и зайти в него через `docker exec`:

```bash
docker ps -a | grep signer
docker exec -it <id_контейнера> bash
```

Внутри Docker-контейнера можно проверить, находится ли криптоконтейнер в нем:

```bash
ls -lah /var/opt/cprocsp/keys/root
```

И с помощью утилиты `csptest` проверить его загрузку в Signer:

```bash
csptest -keyset -enum_cont -verifycontext -fqcn
```

#### Проверка файлов OpenSSL:

Чтобы проверить, загружены ли файлы в signer нужно получить ID Docker-контейнера Signer и зайти в него через `docker exec`:

```bash
docker ps -a | grep signer
docker exec -it <id_контейнера> bash
```

Внутри контейнера можно проверить, находится ли сертификат с ключом в нем:

```bash
ls -lah /home/app/openssl_keys
```

#### Проверка корректной работы сервиса подписания запросов Signer:

Также для проверки корректной работы сервиса подписания запросов (Signer) необходимо выполнить запрос к сервису с помощью команды:

```bash
curl -X POST -d 'content=test' -d 'cert=esia' -u admin:123456 http://127.0.0.1:8505/raw
```

где:

- `esia` - алиас контейнера, заданный в `CRYPTOPRO_CSP_ALIAS`
- `admin` - имя пользователя для http basic authentication, заданный в `SIGNER_USERNAME`
- `123456` - пароль пользователя для http basic authentication, заданный в `SIGNER_PASSWORD`

Корректным результатом выполнения команды будет следующий результат:

```json
{"signature":"FuJIp...jaQCFKjR0J+e+/TzpS8Hsg==","certificate":"MIIKyDC
.......
WddM7aQ89R9akeQ38uYd7usbbw==","certificate_algorithm":"1.2.643.7.1.1.3.2"}
```

[Отдельное описание настройки ПО Сайнер](./esia_signer/README.md)

-----

### Дополнительное ПО

Для корректной работы ЕСИА Шлюза и Сайнера обязательны наличие БД и СУБД (например, PostgreSQL и Redis).

Вместе с основными компонентами (ЕСИА Шлюз и Сайнер) в рамках поставки коробочного решения предоставляются опциональные скрипты для запуска ПО:

- **PostgreSQL**
- **Redis**
- **Nginx**
- **Traefik**

> ***Данное дополнительное ПО поставляется в качестве показательного примера работы с ЕСИА Шлюзом и Сайнером. Рекомендуется заменить дополнительное ПО из данной конфигурации на то, которое применяется (или планируется к применению) в кластере пользователя. Компания RNDS несёт ответственность только за корректную работу ПО собственной разработки - "ЕСИА Шлюз" и "Signer"***

-----

#### Настройка PostgreSQL

`DATABASE_DATA_PATH` - путь к файлам БД PostgreSQL на хостовой машине (по-умолчанию */storage/infra/gate_postgres/data*)

`DATABASE_IMAGE` и `DATABASE_IMAGE_TAG` - значения Docker образа для БД (по-умолчанию для *PostgreSQL 16*)

`DATABASE_HOST` - название хоста БД (по-умолчанию *db*)

`DATABASE_NAME` - название БД (по-умолчанию *main_esia_db*)

`DATABASE_USER` - логин суперпользователя БД (по-умолчанию *postgres*)

`DATABASE_PASS` - пароль суперпользователя БД (по-умолчанию *0QPnk5dVcAEg*)

`DATABASE_PORT` - внешний порт контейнера с БД (по-умолчанию *5432*)

-----

#### Настройка Redis

`REDIS_DATA_PATH` - путь к файлам Redis на хостовой машине (по-умолчанию */storage/infra/redis_postgres/data*)

`REDIS_IMAGE` и `REDIS_IMAGE_TAG` - значения Docker образа для Redis (по-умолчанию *redis:latest*)

`REDIS_PORT` - внешний порт контейнера Redis (по-умолчанию *6379*)

-----

#### Настройка прокси-сервера

В поставке на выбор есть 2 варианта установки прокси-сервера: **Nginx** или **Traefik**


#### **Настройка Nginx**

Для настройки переменных окружения Nginx необходимо перейти к файлу [./nginx/.env](./nginx/.env)

`NGINX_LOGS` - путь к логам Nginx на хостовой машине (по-умолчанию */storage/nginx_log/logs*)

`NGINX_PORT` - Внешний порт контейнера с Nginx (по-умолчанию *443*)

Для настройки конфигурации Nginx необходимо перейти к файлу [./nginx/nginx/nginx.conf](./nginx/nginx/nginx.conf)


#### **Настройка Traefik**

Файл [./traefik/configs/esia.yml](./traefik/configs/esia.yml) :
* В параметре `rule` необходимо указать доменное имя по которому будет доступен ЕСИА-шлюз в формате "Host(\`esia.example.com`)"
* В параметре url необходимо указать URL к ЕСИА-шлюзу в формате "http://address:3000"

Файл [./traefik/configs/esia-gate-private.yml](./traefik/configs/esia-gate-private.yml) :
* В параметре `rule` необходимо указать доменное имя по которому будет доступен ЕСИА-шлюз в формате "Host(\`esia.example.com`)"

Файл [./traefik/configs/middlewares.yml](./traefik/configs/middlewares.yml) :
* В параметре `ipAllowList.sourceRange` необходимо указать IP с которых разрешен доступ к ЕСИА-шлюзу

Файл [./traefik/configs/traefik-dashboard.yml](./traefik/configs/traefik-dashboard.yml)
* В параметре `rule` необходимо указать доменное имя по которому будет доступен ЕСИА-шлюз в формате "Host(\`traefik.esia.example.com`)"

В каталог *./traefik/ssl* необходимо положить ключи для SSL соединения (`cert.crt` и `private.key`). Имя искомых ключей можно задать в файле [./traefik/configs/traefik.yml](./traefik/configs/traefik.yml) в параметрах `certFile` и `keyFile`

-----

## Описание работы скриптов для работы с контейнерами

### Запуск контейнеров

После настройки всех необходимых компонентов коробочного решения, следует воспользоваться скриптом `box_run.sh` с передачей ему некоторых переменных. Сперва данный скрипт генерирует приватный OpenSSL ключ и сохраняет его в ***./esia_gate/openid_signing.key***  
Затем скрипт переходит к рендерингу переменных окружения из `.env.main` и вносит данные изменения в локальные `.env`-файлы каждого запускаемого контейнера.  
И далее скрипт переходит к запуску контейнеров, согласно переменным, описанным ниже.

Данный скрипт подразумевает использование с несколькими переменными:

```bash
./box_run.sh <var1> <var2> ...
```

По-умолчанию, без задания переменных скрипт запускает только ПО *"ЕСИА Шлюз"* и *"Сайнер"*

Список переменных, применимых с данным скриптом:

- `db` - запускает PostgreSQL
- `redis` - запускает Redis
- `nginx` - запускает Nginx
- `traefik` - запускает Traefik

*ЕСИА Шлюз* и *Сайнер* будут запущены всегда, вне зависимости от заданных переменных.

Примеры:

```bash
./box_run.sh # Запуск только ЕСИА Шлюза и Сайнера
./box_run.sh db nginx # Запуск ЕСИА Шлюза и Сайнера, а также PostgreSQL и Nginx
./box_run.sh traefik # Запуск ЕСИА Шлюза и Сайнера, а также Traefik
./box_run.sh nginx redis db # Запуск ЕСИА Шлюза и Сайнера, а также PostgreSQL, Redis и Nginx
```

Запуск выполняется посредством надстройки для Docker -`docker compose up`, после чего будут запущены (в detach режиме) контейнеры с соответствующим ПО. Проверить запущенные контейнеры можно командой:

```bash
docker ps
docker ps -a
```

-----

### Проверка конфигурации контейнеров

Проверку конфигурации контейнеров можно выполнить с помощью скрипта `box_show_config.sh`. Данный скрипт подразумевает использование с несколькими переменными:

```bash
./box_show_config.sh <var1> <var2> ...
```

Список переменных, применимых с данным скриптом:

- `esia` - отображает конфигурацию ЕСИА Шлюз
- `signer` - отображает конфигурацию Signer
- `db` - отображает конфигурацию PostgreSQL
- `redis` - отображает конфигурацию Redis
- `nginx` - отображает конфигурацию Nginx
- `traefik` - отображает конфигурацию Traefik

Отображение конфигурации выполняется посредством надстройки для Docker - `docker compose config`

-----

### Удаление контейнеров

**Удаление** контейнеров и созданных ими сетей можно осуществить с помощью скрипта `box_down.sh`. 

```bash
./box_down.sh <var1> <var2> ...
```

Список переменных, применимых с данным скриптом:

- `esia` - останавливает и удаляет ЕСИА Шлюз
- `signer` - останавливает и удаляет Signer
- `db` - останавливает и удаляет PostgreSQL
- `redis` - останавливает и удаляет Redis
- `nginx` - останавливает и удаляет Nginx
- `traefik` - останавливает и удаляет Traefik
- `all` - останавливает и удаляет все контейнеры в рамках коробки

Удаление выполняется посредством надстройки для Docker - `docker compose down --remove-orphans`
